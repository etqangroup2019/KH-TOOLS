#!/usr/bin/env python3
# -*- coding: utf-8 -*-

"""
Ø³ÙƒØ±ÙŠØ¨Øª Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ Ù„Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
ÙŠÙ‚ÙˆÙ… Ø¨Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© ÙƒØ§Ù…Ù„Ø© Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
"""

import sys
import os
import subprocess
import gzip
import shutil
from datetime import datetime
from pathlib import Path

# Ø¥Ø¶Ø§ÙØ© Ù…Ø³Ø§Ø± Ø§Ù„Ù…Ø´Ø±ÙˆØ¹
project_root = Path(__file__).parent.parent
sys.path.insert(0, str(project_root))

from config.settings import DATABASE_CONFIG, BACKUP_CONFIG, SYSTEM_CONFIG
import logging

# Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø³Ø¬Ù„Ø§Øª
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(levelname)s - %(message)s',
    handlers=[
        logging.FileHandler(project_root / 'logs' / 'backup.log', encoding='utf-8'),
        logging.StreamHandler()
    ]
)
logger = logging.getLogger(__name__)

class DatabaseBackup:
    """
    ÙƒÙ„Ø§Ø³ Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ Ù„Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    """
    
    def __init__(self):
        """ØªÙ‡ÙŠØ¦Ø© ÙƒÙ„Ø§Ø³ Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ"""
        self.db_config = DATABASE_CONFIG
        self.backup_config = BACKUP_CONFIG
        self.backup_path = Path(self.backup_config['backup_path'])
        
        # Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¬Ù„Ø¯ Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹
        self.backup_path.mkdir(parents=True, exist_ok=True)
        
        logger.info("ØªÙ… ØªÙ‡ÙŠØ¦Ø© Ù†Ø¸Ø§Ù… Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ")
    
    def create_backup(self, backup_name=None):
        """
        Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        
        Args:
            backup_name: Ø§Ø³Ù… Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
            
        Returns:
            str: Ù…Ø³Ø§Ø± Ù…Ù„Ù Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ø£Ùˆ None ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„ÙØ´Ù„
        """
        try:
            # Ø¥Ù†Ø´Ø§Ø¡ Ø§Ø³Ù… Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©
            if not backup_name:
                timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
                backup_name = f"{self.db_config['database']}_{timestamp}"
            
            # Ù…Ø³Ø§Ø± Ù…Ù„Ù Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©
            backup_file = self.backup_path / f"{backup_name}.sql"
            
            logger.info(f"Ø¨Ø¯Ø¡ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©: {backup_name}")
            
            # Ø¨Ù†Ø§Ø¡ Ø£Ù…Ø± mysqldump
            mysqldump_cmd = [
                'mysqldump',
                f"--host={self.db_config['host']}",
                f"--user={self.db_config['user']}",
                f"--password={self.db_config['password']}",
                '--single-transaction',
                '--routines',
                '--triggers',
                '--default-character-set=utf8mb4',
                self.db_config['database']
            ]
            
            # ØªÙ†ÙÙŠØ° Ø£Ù…Ø± Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ
            with open(backup_file, 'w', encoding='utf-8') as f:
                result = subprocess.run(
                    mysqldump_cmd,
                    stdout=f,
                    stderr=subprocess.PIPE,
                    text=True,
                    encoding='utf-8'
                )
            
            if result.returncode != 0:
                logger.error(f"ÙØ´Ù„ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©: {result.stderr}")
                if backup_file.exists():
                    backup_file.unlink()
                return None
            
            # Ø¶ØºØ· Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ÙØ¹Ù„Ø§Ù‹
            if self.backup_config['compression']:
                compressed_file = self._compress_backup(backup_file)
                if compressed_file:
                    backup_file.unlink()  # Ø­Ø°Ù Ø§Ù„Ù…Ù„Ù ØºÙŠØ± Ø§Ù„Ù…Ø¶ØºÙˆØ·
                    backup_file = compressed_file
            
            # Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©
            self._add_backup_info(backup_file)
            
            logger.info(f"ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­: {backup_file}")
            
            # ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
            self._cleanup_old_backups()
            
            return str(backup_file)
            
        except Exception as e:
            logger.error(f"Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©: {e}")
            return None
    
    def _compress_backup(self, backup_file):
        """
        Ø¶ØºØ· Ù…Ù„Ù Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©
        
        Args:
            backup_file: Ù…Ø³Ø§Ø± Ù…Ù„Ù Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©
            
        Returns:
            Path: Ù…Ø³Ø§Ø± Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…Ø¶ØºÙˆØ· Ø£Ùˆ None
        """
        try:
            compressed_file = backup_file.with_suffix('.sql.gz')
            
            with open(backup_file, 'rb') as f_in:
                with gzip.open(compressed_file, 'wb') as f_out:
                    shutil.copyfileobj(f_in, f_out)
            
            logger.info(f"ØªÙ… Ø¶ØºØ· Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©: {compressed_file}")
            return compressed_file
            
        except Exception as e:
            logger.error(f"Ø®Ø·Ø£ ÙÙŠ Ø¶ØºØ· Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©: {e}")
            return None
    
    def _add_backup_info(self, backup_file):
        """
        Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©
        
        Args:
            backup_file: Ù…Ø³Ø§Ø± Ù…Ù„Ù Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©
        """
        try:
            info_file = backup_file.with_suffix('.info')
            
            backup_info = {
                'Ø§Ø³Ù…_Ø§Ù„Ù†Ø³Ø®Ø©': backup_file.stem,
                'ØªØ§Ø±ÙŠØ®_Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡': datetime.now().isoformat(),
                'Ù‚Ø§Ø¹Ø¯Ø©_Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª': self.db_config['database'],
                'Ø­Ø¬Ù…_Ø§Ù„Ù…Ù„Ù': backup_file.stat().st_size,
                'Ù†ÙˆØ¹_Ø§Ù„Ø¶ØºØ·': 'gzip' if backup_file.suffix == '.gz' else 'none',
                'Ø¥ØµØ¯Ø§Ø±_Ø§Ù„Ù†Ø¸Ø§Ù…': SYSTEM_CONFIG['version']
            }
            
            with open(info_file, 'w', encoding='utf-8') as f:
                import json
                json.dump(backup_info, f, ensure_ascii=False, indent=2)
            
        except Exception as e:
            logger.warning(f"ØªØ¹Ø°Ø± Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©: {e}")
    
    def _cleanup_old_backups(self):
        """ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©"""
        try:
            max_backups = self.backup_config['max_backups']
            
            # Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ù…Ø±ØªØ¨Ø© Ø­Ø³Ø¨ Ø§Ù„ØªØ§Ø±ÙŠØ®
            backup_files = []
            for file in self.backup_path.glob('*.sql*'):
                if file.suffix in ['.sql', '.gz']:
                    backup_files.append(file)
            
            backup_files.sort(key=lambda x: x.stat().st_mtime, reverse=True)
            
            # Ø­Ø°Ù Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø²Ø§Ø¦Ø¯Ø©
            if len(backup_files) > max_backups:
                for old_backup in backup_files[max_backups:]:
                    try:
                        old_backup.unlink()
                        # Ø­Ø°Ù Ù…Ù„Ù Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø±Ø§ÙÙ‚
                        info_file = old_backup.with_suffix('.info')
                        if info_file.exists():
                            info_file.unlink()
                        logger.info(f"ØªÙ… Ø­Ø°Ù Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©: {old_backup}")
                    except Exception as e:
                        logger.warning(f"ØªØ¹Ø°Ø± Ø­Ø°Ù Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© {old_backup}: {e}")
            
        except Exception as e:
            logger.error(f"Ø®Ø·Ø£ ÙÙŠ ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©: {e}")
    
    def list_backups(self):
        """
        Ø¹Ø±Ø¶ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ø§Ù„Ù…ØªØ§Ø­Ø©
        
        Returns:
            list: Ù‚Ø§Ø¦Ù…Ø© Ø¨Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©
        """
        try:
            backups = []
            
            for backup_file in self.backup_path.glob('*.sql*'):
                if backup_file.suffix in ['.sql', '.gz']:
                    info_file = backup_file.with_suffix('.info')
                    
                    backup_info = {
                        'Ø§Ø³Ù…_Ø§Ù„Ù…Ù„Ù': backup_file.name,
                        'Ø§Ù„Ù…Ø³Ø§Ø±': str(backup_file),
                        'Ø§Ù„Ø­Ø¬Ù…': backup_file.stat().st_size,
                        'ØªØ§Ø±ÙŠØ®_Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡': datetime.fromtimestamp(backup_file.stat().st_mtime)
                    }
                    
                    # Ù‚Ø±Ø§Ø¡Ø© Ù…Ù„Ù Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹
                    if info_file.exists():
                        try:
                            import json
                            with open(info_file, 'r', encoding='utf-8') as f:
                                extra_info = json.load(f)
                                backup_info.update(extra_info)
                        except:
                            pass
                    
                    backups.append(backup_info)
            
            # ØªØ±ØªÙŠØ¨ Ø§Ù„Ù†Ø³Ø® Ø­Ø³Ø¨ Ø§Ù„ØªØ§Ø±ÙŠØ® (Ø§Ù„Ø£Ø­Ø¯Ø« Ø£ÙˆÙ„Ø§Ù‹)
            backups.sort(key=lambda x: x['ØªØ§Ø±ÙŠØ®_Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡'], reverse=True)
            
            return backups
            
        except Exception as e:
            logger.error(f"Ø®Ø·Ø£ ÙÙŠ Ø¹Ø±Ø¶ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©: {e}")
            return []

def main():
    """Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ"""
    print("="*60)
    print("Ù†Ø¸Ø§Ù… Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ - Ù…Ù†Ø¸ÙˆÙ…Ø© Ø§Ù„Ù…Ù‡Ù†Ø¯Ø³ v3")
    print("="*60)
    
    backup_system = DatabaseBackup()
    
    # Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©
    backup_file = backup_system.create_backup()
    
    if backup_file:
        print(f"âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­")
        print(f"ğŸ“ Ø§Ù„Ù…Ø³Ø§Ø±: {backup_file}")
        
        # Ø¹Ø±Ø¶ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©
        print("\n" + "="*60)
        print("Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ø§Ù„Ù…ØªØ§Ø­Ø©:")
        print("="*60)
        
        backups = backup_system.list_backups()
        for i, backup in enumerate(backups[:5], 1):  # Ø¹Ø±Ø¶ Ø¢Ø®Ø± 5 Ù†Ø³Ø®
            size_mb = backup['Ø§Ù„Ø­Ø¬Ù…'] / (1024 * 1024)
            print(f"{i}. {backup['Ø§Ø³Ù…_Ø§Ù„Ù…Ù„Ù']}")
            print(f"   ğŸ“… Ø§Ù„ØªØ§Ø±ÙŠØ®: {backup['ØªØ§Ø±ÙŠØ®_Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡']}")
            print(f"   ğŸ“Š Ø§Ù„Ø­Ø¬Ù…: {size_mb:.2f} MB")
            print()
        
    else:
        print("âŒ ÙØ´Ù„ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©")
        return False
    
    return True

if __name__ == "__main__":
    success = main()
    sys.exit(0 if success else 1)